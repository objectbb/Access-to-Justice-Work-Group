!function(){angular.module("taxidriver",["ui.bootstrap","isteven-multi-select","ui-rangeSlider","ngAnimate","leaflet-directive"]).config(["$httpProvider",function($httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",$httpProvider.defaults.transformRequest.unshift(function(data,headersGetter){var key,result=[];for(key in data)data.hasOwnProperty(key)&&result.push(encodeURIComponent(key)+"="+encodeURIComponent(data[key]));return result.join("&")})}])}(),function(){angular.module("taxidriver").filter("defaultFilter",function(){return function(items,filter){if(!filter)return items;var result={},filterVal=filter.toLowerCase();return angular.forEach(items,function(item,key){var fieldVal=item.hashcode(),splitinput=filterVal.split(" ");fieldVal&&_.intersection(fieldVal,splitinput).length==splitinput.length&&(result[key]=item)}),result}})}(),function(){angular.module("taxidriver").service("ReportService",["$http",function($http){var key="mPLH9KwucKxZZSYDjpAqE1zlZicfCpxL";return{request:function(query,datafileurl){var urlrequest=query?"https://api.mongolab.com/api/1/databases/taxidriver/collections/"+query+"&l=1000000&apiKey="+key:datafileurl;return $http.get(urlrequest).success(function(data){return data}).error(function(err){alert(JSON.stringify(err))})},requestcolumns:function(id){var url="https://api.mongolab.com/api/1/databases/taxidriver/collections/"+id+"?fo=true&apiKey=mPLH9KwucKxZZSYDjpAqE1zlZicfCpxL";return $http.get(url).success(function(data){return data}).error(function(err){alert(JSON.stringify(err))})},requestloc:function(address){var url="https://maps.googleapis.com/maps/api/geocode/json?address="+address;return $http.get(url).success(function(data){return data}).error(function(err){alert(JSON.stringify(err))})}}}])}(),function(){angular.module("taxidriver").directive("tableinfo",["$q","ReportService",function($q,ReportService,$animate){var dataTables={};return{restrict:"E",templateUrl:"js/app/directives/_tableinfo.html",link:function(scope,element,attrs){scope.fusiontbl=JSON.parse(attrs.fusiontbl),scope.title=scope.fusiontbl.title,scope.Id=scope.fusiontbl.Id,scope.columns=scope.fusiontbl.columns,scope.collection=scope.fusiontbl.collection},controller:function($scope){$scope.sqlcols=[],$scope.isprocessing=!1,$scope.send=function(tableid,columns){var msg,msgid="#"+tableid+"msg";$(msgid).html("Processing..."),$(msgid).addClass("flash animated"),$scope.isprocessing=!0;var query=buildquery(tableid);return sendsql(query).then(function(data,status){data.error?msg=data.error.errors[0].message:loaddatagrid(tableid,data,columns),$(msgid).html(msg),$(msgid).removeClass("flash animated")}),$scope.isprocessing=!1,!1};var buildquery=function(tableid){var formcols=$scope.sqlcols.sqlcols,cols=_.map(formcols,function(item){return item.name+":1"});return tableid+"?f={"+cols.join(",")+"}"},sendsql=function(query){var deferred=$q.defer();return ReportService.request(query).success(function(data,status){return deferred.resolve(data)}).error(function(data,status){return deferred.resolve(data)}),deferred.promise},loaddatagrid=function(tableid,dataset,columns){dataTables[tableid]&&dataTables[tableid].fnDestroy();var cols=_.map(columns,function(item){return{data:item.name,title:item.name}});$("#"+tableid+"tablecontainer").addClass("fadeIn animated animate_control"),dataTables[tableid]=$("#"+tableid+"rstable").dataTable({destroy:!0,data:dataset,scrollY:"500px",scrollCollapse:!0,columns:cols,deferRender:!0,searchHighlight:!0}).on("draw.dt",function(){var body=$(this);body.unhighlight(),body.highlight(body.DataTable().search()),msg="..."+dataset.length+" rows returned",$("#"+tableid+"msg").html(msg)})}}}}])}(),function(){var dataTables={};angular.module("taxidriver").controller("AppCtrl",["$scope","$q","ReportService",function($scope,$q,ReportService,$animate){$scope.sql=null,$scope.sqlrs=null,$scope.fusionmap={},$scope.fusionmap["1ONuiVrSyTeh6DBUOyvYUfWSi5s9sAgmVYsc8MF9i"]={Id:"1ONuiVrSyTeh6DBUOyvYUfWSi5s9sAgmVYsc8MF9i",name:"tmhs",collection:"medallions",title:"Taxi Medallion Holders Summary",cols:"*"},$scope.fusionmap["1T1uO4iCjVUps7Ihzc2_avzW2ZGCZR6ciF7IG3lHt"]={Id:"1T1uO4iCjVUps7Ihzc2_avzW2ZGCZR6ciF7IG3lHt",name:"anovs",collection:"anov",title:"Doc & ANOV ers Summary",cols:"*"},$scope.fusionmap["1An33ZqdkTpqMM1UjNy1cW0QDfAUhR0Hdtad0vkpJ"]={Id:"1An33ZqdkTpqMM1UjNy1cW0QDfAUhR0Hdtad0vkpJ",name:"vr",title:"Violations Report",collection:"violation_arbitration",cols:"Disposition_Description,Docket_Number",navigationProperties:{category:{entityTypeName:"anovs",associationName:"vr_anovs",foreignKeyNames:["Docket_Number"]}}},$scope.fusionmap["14EXK6TvoG0XUY9PJzxUPfLTl5FjlsSEeidkA8mNV"]={Id:"14EXK6TvoG0XUY9PJzxUPfLTl5FjlsSEeidkA8mNV",name:"dfin",cols:"*",title:"deptFin_foia",collection:"violations",navigationProperties:{category:{entityTypeName:"anovs",associationName:"dfin_anovs",foreignKeyNames:["Docket_Number"]}}};var getcolumns=function(id){var rs,deferred=$q.defer();return ReportService.requestcolumns(id).success(function(data,status){rs=deferred.resolve(_.map(_.keys(data).sort(),function(item){return{name:item}}))},function(updates){deferred.update(updates)}),deferred.promise},initload=function(){var ft=$scope.fusionmap;for(var key in ft)!function(key){var collection=(ft[key].name,ft[key].cols,ft[key].collection);getcolumns(collection).then(function(data){ft[key].columns=data}),ft[key].hashcode=function(){var tree=_.map(ft[key].columns,function(item){return item.name.toLowerCase().split(/[_# -]/g)});return tree=tree.concat(ft[key].title.toLowerCase().split(/[_# -]/g)),_.flatten(tree)}}(key)};initload(),$scope.loadcachetables=function(sql,tableid){sendsql(sql,tableid).then(function(data,status){data.error?msg=data.error.errors[0].message:msg="Results at the bottom..."+data.rows.length+" rows returned",console.log(msg)})},$scope.sendadvsql=function(sql,tableid){var msg,msgid="#"+tableid+"msg";$(msgid).html("Processing..."),sendsql(sql,tableid).then(function(data,status){data.error?msg=data.error.errors[0].message:(loaddatagrid(tableid,data),msg="Results at the bottom..."+data.rows.length+" rows returned"),$(msgid).html(msg)})};var sendsql=function(query,tableid){var deferred=$q.defer();return ReportService.request(query).success(function(data,status){return deferred.resolve(data)},function(updates){deferred.update(updates)}).error(function(data,status){return deferred.resolve(data)}),deferred.promise},loaddatagrid=function(tableid,dataset){dataTables[tableid]&&dataTables[tableid].fnDestroy();var cols=_.map(dataset.columns,function(n){return{title:n}});$("#tablecontainer").addClass("fadeIn animate_control"),dataTables[tableid]=$("#"+tableid+"rstable").empty().dataTable({destroy:!0,data:dataset.rows,scrollY:"500px",scrollCollapse:!0,columns:cols,deferRender:!0}).on("draw.dt",function(){var body=$(this);body.unhighlight(),body.highlight(body.DataTable().search())})}}])}(),function(){angular.module("taxidriver").controller("MapController",["$scope","$filter","$q","$animate","ReportService","leafletData","leafletEvents",function($scope,$filter,$q,$animate,ReportService,leafletData,leafletEvents){$scope.status="All",$scope.minAmount=0,$scope.maxAmount=250,$scope.fromdate=new Date(2013,3,1),$scope.todate=new Date(2013,3,30),$scope.table="14EXK6TvoG0XUY9PJzxUPfLTl5FjlsSEeidkA8mNV",$scope.filteredMaxFine=250,$scope.filteredMinFine=0,$scope.filteredViolations="All",$scope.filtertotalcount=0,$scope.filtertotalviolations=0,$scope.filtertotalamount=0,$scope.iscurrviewstats=!1,$scope.maploc,$scope.violations=[],$scope.allviolations=[];var rawdata=[];$scope.mapboundary;var addressPointsToMarkers=function(points,stylef,bodyf){return points.map(function(ap){return{data:ap,layer:"realworld",lat:ap.loc[1],lng:ap.loc[0],message:_.values(ap).join("<br>"),icon:{type:"div",className:stylef(ap),iconSize:null,html:bodyf(ap)},label:{message:_.values(ap).join("<br>"),options:{noHide:!0}}}})},refreshViolationsdd=function(data){$scope.allviolations=_.uniq(_.map(data,function(item){return{id:item.Id,name:item.Description,label:item.Description}}),"name"),$scope.allviolations=$filter("orderBy")($scope.allviolations,"name",!1)},loadMapData=function(query,datafileurl){var deferred=$q.defer();return ReportService.request(query,datafileurl).success(function(data,status){deferred.resolve(data)}).error(function(data,status){changefiltertext("filterstate","Failed: "+status,"animated infinite fadeIn")}),deferred.promise},changefiltertext=function(id,text,effect){$("#"+id).removeClass(effect).addClass(effect),$scope.filterstate=text};$scope.$on("leafletDirectiveMap.moveend",function(event,args){$scope.setDirty(),$scope.mapboundary=leafletData.getMap("taxidrivermap").then(function(map){return map.getBounds()})});var isBoundary=function(coord){if(!$scope.mapboundary)return!0;var currboundary=$scope.mapboundary.$$state.value;return currboundary._northEast.lat>=coord.loc[1]&&currboundary._northEast.lng>=coord.loc[0]&&currboundary._southWest.lat<=coord.loc[1]&&currboundary._southWest.lng<=coord.loc[0]},filtermarkers=function(rawdata){var minfine=250,maxfine=0,tallyamount=0,allvio={};if(0!=rawdata.length){changefiltertext("filterstats","Filtering...");var rs=_.filter(rawdata,function(item){var dataprop=item,is=null!=dataprop.loc&&moment(dataprop.Date).isBetween($scope.fromdate,$scope.todate)&&dataprop.Amount>=$scope.minAmount&&dataprop.Amount<=$scope.maxAmount&&(_.find($scope.violations,{name:dataprop.Description})||0==$scope.violations.length)&&(dataprop.Status==$scope.status||"All"==$scope.status),isbound=is&&($scope.iscurrviewstats?isBoundary(dataprop):!0);return isbound&&(dataprop.Amount>=maxfine&&(maxfine=dataprop.Amount),dataprop.Amount<=minfine&&(minfine=dataprop.Amount),allvio[dataprop.Description]={name:dataprop.Description,ticked:!0},tallyamount+=dataprop.Amount),isbound});return $scope.filteredMaxFine=maxfine,$scope.filteredMinFine=minfine,$scope.filtertotalviolations=_.keys(allvio).length,_.map($scope.allviolations,function(item){item.ticked=allvio[item.name]?!0:!1}),$scope.filtertotalcount=rs.length,$scope.filtertotalamount=tallyamount,changefiltertext("filterstate","Finish Calculating..."),rs}},setMapData=function(rawdata,stylef,bodyf){return $q(function(resolve,reject){resolve(addressPointsToMarkers(filtermarkers(rawdata),stylef,bodyf))})},mapIt=function(){angular.extend($scope,{center:{lat:41.8369,lng:-87.6847,zoom:9},events:{map:{enable:["moveend","click"],logic:"emit"},marker:{enable:[],logic:"emit"}},layers:{baselayers:{osm:{name:"OpenStreetMap",type:"xyz",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}},overlays:{realworld:{name:"Real world data",type:"markercluster",visible:!0}}}})};mapIt();var medalstyleconfig=function(obj){return"map-marker"},medaldataconfig=function(obj){return'<div class="icon">'+obj.Company_Name+'</div><div class="arrow" />'},violationstyleconfig=function(obj){return"map-marker "+("Paid"==obj.Status?"green":"Outstanding"==obj.Status?"red":"")},violationdataconfig=function(obj){return'<div class="icon">$'+obj.Amount+" "+obj.Description+" "+obj.Date+'</div><div class="arrow" />'},centerview=function(){angular.extend($scope,{center:{lat:41.8369,lng:-87.6847,zoom:9}})},refreshMap=function(url,dataurl,setmap){centerview(),changefiltertext("filterstate","Loading Data..."),loadMapData(url,dataurl).then(changefiltertext("filterstate","Filtering...")).then(function(data){return 0!=data.length?(rawdata=data,refreshViolationsdd(data),$q(function(resolve,reject){resolve(setmap(data))}).then(function(data){$scope.markers=data},function(error){changefiltertext("filterstate","Failed: "+error,"animated infinite fadeIn")})["finally"](changefiltertext("filterstats","Mapping Finished..."))):void 0},function(reason){changefiltertext("filterstate","Failed: "+reason,"animated infinite fadeIn")})},refreshMapViolations=function(url,dataurl){refreshMap(url,dataurl,function(data){return setMapData(data,violationstyleconfig,violationdataconfig)})},refreshMapMedallions=function(url,dataurl){refreshMap(url,dataurl,function(data){return addressPointsToMarkers(data,medalstyleconfig,medaldataconfig)})};changefiltertext("filterstate","..."),refreshMapViolations.apply(this,["","data/violations_map.json"]),$scope.mapViolations=function(){$scope.table="14EXK6TvoG0XUY9PJzxUPfLTl5FjlsSEeidkA8mNV",refreshMapViolations.apply(this,["","data/violations_map.json"])},$scope.mapMedallions=function(){$scope.table="1ONuiVrSyTeh6DBUOyvYUfWSi5s9sAgmVYsc8MF9i";var query="medallions?q={lat:{$gt:0},lng:{$lt:0}}&f={_id:0,Company_Name_UNEDITED:0,EDIT:0}";refreshMapMedallions.apply(this,[query,""])},$scope.setDirty=function(){$scope.mappingform.$setDirty(!0)},$scope.centermap=function(){$scope.maploc&&(changefiltertext("filterstate","Mapping..."+$scope.maploc),ReportService.requestloc($scope.maploc).success(function(data,status){var loc=data.results[0].geometry.location;angular.extend($scope,{center:{lat:loc.lat,lng:loc.lng,zoom:20}})}).error(function(data,status){changefiltertext("filterstate","Failed: "+status,"animated infinite fadeIn")}))},$scope.onchangeRedrawmap=function(){0!=rawdata.length&&setMapData(rawdata,violationstyleconfig,violationdataconfig).then(function(data){$scope.markers=data,changefiltertext("filterstats","Re-mapping Finished..."),$scope.mappingform.$setPristine(!0)},function(err){changefiltertext("filterstate","Error..."+err,"animated infinite fadeIn")})}}])}();